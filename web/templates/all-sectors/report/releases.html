{% extends 'layout/layout.html' %}

{% macro errtext(errno) %}
{% if errno === 'PI-1000' %}
<span class="error-message">Must be a number or BRT</span>
{% elif errno === 'PI-1001' %}
<span class="error-message">Do not specify a unit with BRT</span>
{% elif errno === 'PI-1002' %}
<span class="error-message">A value must have units</span>
{% else %}
<span class="error-message">Unknown error</span>
{% endif %}
{% endmacro %}

{% macro form(header, errorheader, action) %}
<form id="main-form" action="{{ action }}-action" method="post" class="form">
    <div class="form-group"><a id="back" href="#" class="action">Back to tasks</a></div>

    {{ substancesWithErrors | dump }}

    {% if (releases | substancesWithErrors | length) === 0 %}
    <h1 class="heading-large">{{ header }}</h1>
    {% else %}
    <div class="error-summary" role="alert" aria-labelledby="error-summary-heading-example-2" tabindex="-1">
        <h2 class="heading-large error-summary-heading" id="error-summary-heading-example-2">
            {{ errorheader }}
        </h2>
        <p>There are issues with the data</p>
        <p>Check your reports for:</p>
        <ul class="error-summary-list">
            {% for substance in releases | substancesWithErrors %}
            <li><a href="#substance-{{ substance.id }}">{{ substance.name }}</a></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <table class="check-data table-control mobile-format">

        <thead>
        <tr>
            <th class="th-substance">Substance</th>
            <th class="th-reporting-threshold numeric">2017 threshold</th>
            <th class="th-release">2017 total</th>
            <th class="th-unit">Unit</th>
            <th class="th-action"><span class="visually-hidden">More detail</span></th>
        </tr>
        </thead>

        <tbody>
        {% for release in releases %}
        <tr>
            <td class="td-substance"><div id="#substance-{{ release.substance.id }}">{{ release.substance.name }}</div></td>
            <td class="td-reporting-threshold numeric"/>

            {%if ( release.errors | concernsElement('value') ) if release.errors %}
            <td class="td-release">
                <div class="form-group-error">
                    <label class="form-label visually-hidden" for="value-err{{ release.substance.id }}">Releases</label>
                    <input class="form-control form-control-error" id="value-err{{ release.substance.id }}" name="value-{{ release.substance.id }}" value="{{ release.value }}">
                    {{ errtext(release.errors | concernsElement('value')) }}
                </div>
            </td>
            {% else %}
            <td class="td-release">
                <div class="form-group">
                    <label class="form-label visually-hidden" for="value-{{ release.substance.id }}">Releases</label>
                    <input class="form-control" id="value-{{ release.substance.id }}" name="value-{{ release.substance.id }}" value="{{ release.value }}">
                </div>
            </td>
            {% endif %}

            <td class="td-unit">
                {%if ( release.errors | concernsElement('unit') ) if release.errors %}
                <div class="form-group">
                    <label class="form-label visually-hidden" for="unit-err{{ release.substance.id }}">Unit</label>
                    <select class="form-control form-control-error unit" id="unit-err{{ release.substance.id }}" name="unitId-{{ release.substance.id }}">
                        <option>--</option>
                        {% for unit in units %}
                        {% if release.unitId === unit.id %}
                        <option selected value="{{ unit.id }}">{{ unit.name }}</option>
                        {% else %}
                        <option value="{{ unit.id }}">{{ unit.name }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                {% else %}
                <div class="form-group">
                    <label class="form-label visually-hidden" for="unit-{{ release.substance.id }}">Unit</label>
                    <select class="form-control unit" id="unit-{{ release.substance.id }}" name="unitId-{{ release.substance.id }}">
                        <option>--</option>
                        {% for unit in units %}
                        {% if release.unitId === unit.id %}
                        <option selected value="{{ unit.id }}">{{ unit.name }}</option>
                        {% else %}
                        <option value="{{ unit.id }}">{{ unit.name }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </td>

            <td class="td-action"><a id="detail" href="#" class="action">More Detail</a></td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="form-group"><a id="add-substance" href="#" class="action">Add substance</a></div>
    <div class="form-group"><button type="button" id="continue" class="button action" >Continue</button></div>
    <input type="hidden" id="action" name="action">
</form>
{% endmacro %}

{% block body_start %}
<script>
  $(function(){
        $('.action').click(function(event) {
            $('#action').val(event.target.id);
            $('#main-form').submit();
        });
  });
</script>
{% endblock %}

{% block content %}
<main id="content">
    <h1 class="heading-large">{{ header }}</h1>
    <h2 class="font-medium">EA_ID: {{ eaId }}</h2>
    <label id="page-name" hidden>releases</label>
    {% if task === 'RELEASES_TO_LAND' %}
    {{ form('Your releases to land?', 'Check your releases to land', '/land') }}
    {% elif task === 'RELEASES_TO_AIR' %}
    {{ form('Your releases to air?', 'Check your releases to air', '/air') }}
    {% elif task === 'RELEASES_TO_CONTROLLED_WATERS' %}
    {{ form('Your releases to controlled waters?', 'Check your releases to controlled waters', '/water') }}
    {% elif task === 'OFFSITE_TRANSFERS_IN_WASTE_WATER' %}
    {{ form('Your transfers of substances off-site in waste water?', 'Check your releases in waste water', '/waste-water') }}
    {% endif %}
</main>
{% endblock %}