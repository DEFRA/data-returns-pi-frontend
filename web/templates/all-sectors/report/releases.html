{% extends 'layout/layout.html' %}

{% macro errtext(errno) %}
{% if errno === 'PI-1000' %}
<span class="error-message">Enter a number or ‘BRT’</span>
{% elif errno === 'PI-1001' %}
<span class="error-message">Do not specify units with BRT</span>
{% elif errno === 'PI-1002' %}
<span class="error-message">A value must have units</span>
{% else %}
<span class="error-message">Unknown error</span>
{% endif %}
{% endmacro %}

{% macro form(header, errorheader, release) %}
<form id="main-form" action="{{ release }}/action" method="post" class="form">

    {% if (releases | parametersWithErrors | length) === 0 %}
    <h1 class="heading-large">{{ header }}</h1>
    {% else %}
    <div class="error-summary" role="alert" aria-labelledby="check-your-report" tabindex="-1">
        <h2 class="heading-medium error-summary-heading" id="check-your-report">
            {{ errorheader }}
        </h2>
        <ul class="error-summary-list">
            {% for parameter in releases | parametersWithErrors %}
            <li><a href="#parameter-{{ parameter.id }}">Check your {{ parameter.nomenclature }} report</a></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <table class="summary-table table-control">
        <thead>
        <tr>
            <th class="th-parameter">Substance</th>
            <th class="th-reporting-threshold numeric">Threshold</th>
            <th class="th-release">Total</th>
            <th class="th-unit">Unit</th>
            <th class="th-more-detail"><span class="visually-hidden">More detail</span></th>
            <th class="th-delete"><span class="visually-hidden">Delete</span></th>
        </tr>
        </thead>

        <tbody>
        {% for release in releases %}
        <tr>

            <td class="td-parameter"><div id="parameter-{{ release.parameter.id }}">{{ release.parameter.nomenclature }}</div></td>
            <td class="td-reporting-threshold numeric">
                {{ release.parameter.threshold.value }} {{ release.parameter.threshold.unit.nomenclature }}
            </td>

            {% set value_error = (release.errors | selectattr2("key", "value"))  %}
            {% set unit_error = (release.errors | selectattr2("key", "unitId"))  %}

            {% if value_error %}
            <td class="td-release">
                <div class="form-group-error">
					{% if value_error %}
						{{ errtext(value_error.errno) }}
					{% endif %}
                    <label class="form-label visually-hidden" for="value-err{{ release.parameter.id }}">Releases</label>
                    <input class="form-control form-control-error" id="value-err{{ release.parameter.id }}" name="value-{{ release.parameter.id }}" value="{{ release.value }}">
                </div>
            </td>
            {% else %}
            <td class="td-release">
                <label class="form-label visually-hidden" for="value-{{ release.parameter.id }}">Releases</label>
                <input class="form-control" id="value-{{ release.parameter.id }}" name="value-{{ release.parameter.id }}" value="{{ release.value }}">
            </td>
            {% endif %}

            <td class="td-unit">
                {%if unit_error %}
	            <div class="form-group-error">
                    {% if unit_error %}
                        {{ errtext(unit_error.errno) }}
                    {% endif %}
                    <label class="form-label visually-hidden" for="unit-err{{ release.parameter.id }}">Unit</label>
	                <select class="form-control form-control-error unit" id="unit-err{{ release.parameter.id }}" name="unitId-{{ release.parameter.id }}">
	                    <option>--</option>
	                    {% for unit in units %}
	                    {% if release.unitId === unit.id %}
	                    <option selected value="{{ unit.id }}">{{ unit.nomenclature }}</option>
	                    {% else %}
	                    <option value="{{ unit.id }}">{{ unit.nomenclature }}</option>
	                    {% endif %}
	                    {% endfor %}
	                </select>
	                {% else %}
	                <label class="form-label visually-hidden" for="unit-{{ release.parameter.id }}">Unit</label>
	                <select class="form-control unit" id="unit-{{ release.parameter.id }}" name="unitId-{{ release.parameter.id }}">
	                    <option>--</option>
	                    {% for unit in units %}
	                    {% if release.unitId === unit.id %}
	                    <option selected value="{{ unit.id }}">{{ unit.nomenclature }}</option>
	                    {% else %}
	                    <option value="{{ unit.id }}">{{ unit.nomenclature }}</option>
	                    {% endif %}
	                    {% endfor %}
	                </select>
				</div>
                {% endif %}
            </td>

            <td>
                <input class="link" type="submit" id="detail-{{ release.parameter.id }}" name="detail-{{ release.parameter.id }}" value="More detail"/>
            </td>

            <td>
                <input class="link delete" type="submit" id="delete-{{ release.parameter.id }}" name="delete-{{ release.parameter.id }}" value="Delete"/>
            </td>

        </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="form-group">
		<input class="link" type="submit" id="add" name="add" value="Add a substance"/>
	</div>
    <div class="form-group">
		<input class="button" type="submit" id="continueBtn" name="continue" value="Continue"/>
	</div>

 </form>
{% endmacro %}

{% block content %}
<main id="content">
    <label id="page-name" hidden>releases-{{ route.pathParam }}</label>
    <a href="/task-list" class="link-back">Back to sections you must complete</a>
    <h1 class="heading-large">{{ header }}</h1>
    {% if route.name === 'RELEASES_TO_LAND' %}
    {{ form('Your releases to land', 'Check what you’re reporting', '/releases/land') }}
    {% elif route.name === 'RELEASES_TO_AIR' %}
    {{ form('Your releases to air', 'Check what you’re reporting', '/releases/air') }}
    {% elif route.name === 'RELEASES_TO_CONTROLLED_WATERS' %}
    {{ form('Your releases to controlled waters', 'Check what you’re reporting', '/releases/water') }}
    {% elif route.name === 'OFFSITE_TRANSFERS_IN_WASTE_WATER' %}
    {{ form('Your substances transferred off site in wastewater', 'Check what you’re reporting', '/releases/waste-water') }}
    {% endif %}
</main>
{% endblock %}
