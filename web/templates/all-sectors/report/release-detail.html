{% extends 'layout/layout.html' %}

{% macro form(description, action) %}

{% set value_error = (release.errors | selectattr2("key", "value"))  %}
{% set unit_error = (release.errors | selectattr2("key", "unitId"))  %}
{% set method_error = (release.errors | selectattr2("key", "methodId"))  %}
{% set notifiable_unit_error = (release.errors | selectattr2("key", "notifiableUnitId"))  %}
{% set notifiable_value_error = (release.errors | selectattr2("key", "notifiableValue"))  %}

<form id="main-form" action="{{ action }}" method="post" class="form">
    <a href="/task-list" class="link-back">Back to sections you must complete</a>
    <h1 class="heading-large">Your release of {{ release.parameter.name }} {{ description }}</h1>

    {% if release.errors %}
    <div class="error-summary" role="alert" aria-labelledby="check-your-report" tabindex="-1">
        <h2 class="heading-medium error-summary-heading" id="check-your-report">
            Check what you’re reporting
        </h2>
        <ul class="error-summary-list">
            {% if value_error and value_error.errno === 'PI-1000' %}
            <li><a href="#value-check">Enter a total in digits</a>
            {% endif %}

            {% if unit_error and unit_error.errno === 'PI-1001' %}
            <li><a href="#unit-check">Units are not needed with 'BRT'</a>
            {% endif %}

            {% if unit_error and unit_error.errno === 'PI-1002' %}
            <li><a href="#unit-check">Tell us your measurement unit</a>
            {% endif %}

            {% if value_error and value_error.errno === 'PI-1004' %}
            <li><a href="#value-check">You must submit a numeric overall release amount for where there is a notifiable release</a>
            {% endif %}

            {% if method_error %}
            <li><a href="#method-check">Tell us your measurement method</a>
            {% endif %}

            {% if notifiable_value_error and notifiable_value_error.errno === 'PI-1005' %}
            <li><a href="#method-check">You must give a value for a notifiable release</a>
            {% endif %}

            {% if notifiable_unit_error and notifiable_unit_error.errno === 'PI-1007' %}
            <li><a href="#method-check">You must select a unit of measure for a notifiable release</a>
            {% endif %}

        </ul>
    </div>
    {% endif %}

    <div class="grid-row">
        <div class="column-two-thirds">
            <table class="more-detail table-control">
                <thead> </thead>
                <tbody>
                <tr>
                    <th id="value-check">Total</th>

                    {% if value_error %}
                    <td class="td-release">
                        <div class="form-group-error">
                            <span class="error-message">Enter a number or ‘BRT’ (below reporting threshold)</span>
                            <label class="form-label visually-hidden" for="value-err">Releases</label>
                            <input class="form-control form-control-error" id="value-err" name="value" value="{{ release.value }}">
                        </div>
                    </td>
                    {% else %}
                    <td class="td-release">
                        <label class="form-label visually-hidden" for="value">Releases</label>
                        <input class="form-control" id="value" name="value" value="{{ release.value }}">
                    </td>
                    {% endif %}
                </tr>

                <tr>
                    <td>Threshold</td>
                    <td>{{ release.parameter.threshold.value }} {{ release.parameter.threshold.unit.nomenclature }}</td>
                </tr>

                <tr>
                    <th id="unit-check">Unit of measurement</th>
                    <td class="td-unit">
                        {%if unit_error %}
	                    <div class="form-group-error">
                            {% if unit_error.errno === 'PI-1001' %}
                                <span class="error-message">Do not select unit</span>
                            {% else %}
                                <span class="error-message">Select a type of unit</span>
                            {% endif %}
                            <label class="form-label visually-hidden" for="unit-err">Unit</label>
                            <select class="form-control form-control-error unit" id="unit-err" name="unitId">
                                <option>--</option>
                                {% for unit in units %}
                                    {% if release.unitId === unit.id %}
                                    <option selected value="{{ unit.id }}">{{ unit.nomenclature }}</option>
                                    {% else %}
                                    <option value="{{ unit.id }}">{{ unit.nomenclature }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <label class="form-label visually-hidden" for="unit">Unit</label>
                        <select class="form-control unit" id="unit" name="unitId">
                            <option>--</option>
                            {% for unit in units %}
                                {% if release.unitId === unit.id %}
                                <option selected value="{{ unit.id }}">{{ unit.nomenclature }}</option>
                                {% else %}
                                <option value="{{ unit.id }}">{{ unit.nomenclature }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% endif %}
                    </td>
                </tr>

                <tr>
                    <th id="method-check" class="method">Method</th>
                    <td class="method">
                    {%if method_error %}
	                    <div class="form-group-error">
                            <span class="error-message">Select your method</span>
	                        <label class="form-label visually-hidden" for="method-err">Method</label>
	                        <select class="form-control form-control-error method" id="method-err" name="methodId">
	                            <option>--</option>
	                            {% for method in methods %}
                                    {% if release.methodId === method.id %}
                                    <option selected value="{{ method.id }}">{{ method.name }}</option>
                                    {% else %}
                                    <option value="{{ method.id }}">{{ method.name }}</option>
                                    {% endif %}
	                            {% endfor %}
	                        </select>
						</div>
                    {% else %}
                        <label class="form-label visually-hidden" for="method">Method</label>
                        <select class="form-control method" id="method" name="methodId">
                            <option>--</option>
                            {% for method in methods %}
                                {% if release.methodId === method.id %}
                                <option selected value="{{ method.id }}">{{ method.name }}</option>
                                {% else %}
                                <option value="{{ method.id }}">{{ method.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% endif %}
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="form-group">
                <fieldset class="inline">
                    <h1 class="heading-medium">
                        Notifiable release?
                    </h1>
                    <div class="multiple-choice"> <input id="radio-inline-1" {% if release.notifiable %}checked{% endif %} type="radio" name="hasNotifiableRelease" value="Yes" onclick="show2();"> <label for="radio-inline-1">Yes</label> </div>
                    <div class="multiple-choice"> <input id="radio-inline-2" {% if not release.notifiable %}checked{% endif %} type="radio" name="hasNotifiableRelease" value="No" onclick="show1();"> <label for="radio-inline-2">No</label> </div>
                </fieldset>
            </div>

            <div class="form-group">
                <div class="panel panel-border-narrow hide" id="notifiable-release" style="display:{% if release.notifiable %}block{% else %}none{% endif %};">
                    <table class="more-detail table-control mobile-format">
                        <thead> </thead>
                        <tbody>
                        <tr>
                            <th class="release-amount">Release amount</th>
                            <td class="release-amount-value">
                                <label class="form-label visually-hidden" for="notifiable-release-total">Notifiable release total</label>
                                <input class="form-control" id="notifiable-release-total" name="notifiableValue" type="text" value="{{ release.notifiable.value }}">
                            </td>
                        </tr>
                        <tr>
                            <th class="unit">Unit of measurement</th>
                            <td class="unit-value"> <label class="form-label visually-hidden" for="unit-notifiable">Unit</label>

                                {%if unit_notifiable_error %}
                                <div class="form-group-error">
                                    <span class="error-message">Select a type of unit</span>
                                    <label class="form-label visually-hidden" for="unit-err">Unit</label>
                                    <select class="form-control form-control-error unit" id="unit-notifiable-err" name="notifiableUnitId">
                                        <option>--</option>
                                        {% for unit in units %}
                                            {% if release.unitId === unit.id %}
                                            <option selected value="{{ unit.id }}">{{ unit.name }}</option>
                                            {% else %}
                                            <option value="{{ unit.id }}">{{ unit.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                {% else %}
                                <label class="form-label visually-hidden" for="unit">Unit</label>
                                <select class="form-control unit" id="unit-notifiable" name="notifiableUnitId">
                                    <option>--</option>
                                    {% for unit in units %}
                                        {% if release.notifiable.unitId === unit.id %}
                                        <option selected value="{{ unit.id }}">{{ unit.name }}</option>
                                        {% else %}
                                        <option value="{{ unit.id }}">{{ unit.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                {% endif %}

                            </td>
                        </tr>
                        <tr>
                            <th class="cause">What caused this release?</th>
                            <td class="cause-value"> <textarea maxlength="500" name="notifiableReason" style="height:150px; width:100%" >{{ release.notifiable.reason }}</textarea> </td>
                        </tr>
                        <tr>
                        </tr></tbody>
                    </table>
                </div>
            </div>

            <div class="form-group"> <input type="submit" class="button" id="continueBtn" value="Continue"> </div>
        </div>
    </div>
</form>
{% endmacro %}


{% block content %}

<main id="content">

    <script>
      function show1(){
        document.getElementById('notifiable-release').style.display ='none';
      }
      function show2(){
        document.getElementById('notifiable-release').style.display = 'block';
      }
    </script>

    <label id="page-name" hidden>releases-detail-{{ route.pathParam }}</label>

    {% if route.name === 'RELEASES_TO_LAND' %}
    {{ form('to land', '/releases/land/detail') }}
    {% elif route.name === 'RELEASES_TO_AIR' %}
    {{ form('to air', '/releases/air/detail') }}
    {% elif route.name === 'RELEASES_TO_CONTROLLED_WATERS' %}
    {{ form('to controlled waters', '/releases/water/detail') }}
    {% elif route.name === 'OFFSITE_TRANSFERS_IN_WASTE_WATER' %}
    {{ form('in waste water', '/releases/waste-water/detail') }}
    {% endif %}
</main>

{% endblock %}
