{% extends 'layout/layout.html' %}

{% macro errtext(errno) %}
    {% if errno === 'PI-1000' %}
    <span class="error-message">Enter a number or ‘BRT’ (below reporting threshold)</span>
    {% elif errno === 'PI-1001' %}
    <span class="error-message">Do not specify a unit with BRT</span>
    {% elif errno === 'PI-1002' %}
    <span class="error-message">Select a type of unit</span>
    {% elif errno === 'PI-1003' %}
    <span class="error-message">Select your method</span>
    {% else %}
    <span class="error-message">Unknown error</span>
    {% endif %}
{% endmacro %}

{% macro form(description, action) %}

{% set value_error = (release.errors | selectattr2("key", "value"))  %}
{% set unit_error = (release.errors | selectattr2("key", "unitId"))  %}
{% set method_error = (release.errors | selectattr2("key", "methodId"))  %}

<form id="main-form" action="{{ action }}" method="post" class="form">
    <a href="/task-list" class="link-back">Back to sections you must complete</a>
    <h1 class="heading-large">Your release of {{ release.substance.name }} {{ description }}</h1>

    {% if release.errors %}
    <div class="error-summary" role="alert" aria-labelledby="error-summary-heading-example-2" tabindex="-1">
        <h2 class="heading-medium error-summary-heading" id="error-summary-heading-example-2">
            Check what you’re reporting
        </h2>
        <p>There are issues with the data</p>
        <ul class="error-summary-list">
            {% if value_error %}
            <li><a href="#value-check">{{ errtext(value_error.errno) }}</a>
            {% endif %}

            {% if unit_error %}
            <li><a href="#unit-check">{{ errtext(unit_error.errno) }}</a>
            {% endif %}

            {% if method_error %}
            <li><a href="#method-check">{{ errtext(method_error.errno) }}</a>
            {% endif %}
        </ul>
    </div>
    {% endif %}

    <div class="grid-row">
        <div class="column-two-thirds">
            <table class="more-detail table-control">
                <thead> </thead>
                <tbody>
				<!-- jgillies hid this
                <tr>
                    <th class="reporting-threshold">Reporting threshold</th>
                    <td class="reporting-threshold-value"></td>
                </tr>
				-->
                <tr>
                    <th class="id=value-check">Total</th>

                    {% if value_error %}
                    <td class="td-release">
                        <div class="form-group-error">
							{{ errtext(value_error.errno) }}
                            <label class="form-label visually-hidden" for="value-err">Releases</label>
                            <input class="form-control form-control-error" id="value-err" name="value" value="{{ release.value }}">
                        </div>
                    </td>
                    {% else %}
                    <td class="td-release">
                        <label class="form-label visually-hidden" for="value">Releases</label>
                        <input class="form-control" id="value" name="value" value="{{ release.value }}">
                    </td>
                    {% endif %}
                </tr>

                <tr>
                    <th id="unit-check">Unit</th>
                    <td class="td-unit">
                        {%if unit_error %}
	                    <div class="form-group-error">
							{{ errtext(unit_error.errno) }}
                            <label class="form-label visually-hidden" for="unit-err">Unit</label>
                            <select class="form-control form-control-error unit" id="unit-err" name="unitId">
                                <option>--</option>
                                {% for unit in units %}
                                {% if release.unitId === unit.id %}
                                <option selected value="{{ unit.id }}">{{ unit.name }}</option>
                                {% else %}
                                <option value="{{ unit.id }}">{{ unit.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <label class="form-label visually-hidden" for="unit">Unit</label>
                        <select class="form-control unit" id="unit" name="unitId">
                            <option>--</option>
                            {% for unit in units %}
                            {% if release.unitId === unit.id %}
                            <option selected value="{{ unit.id }}">{{ unit.name }}</option>
                            {% else %}
                            <option value="{{ unit.id }}">{{ unit.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th class="id=method-check" class="method">Method</th>
                    <td class="method">
                    {%if method_error %}
	                    <div class="form-group-error">
							{{ errtext(method_error.errno) }}
	                        <label class="form-label visually-hidden" for="method-err">Method</label>
	                        <select class="form-control form-control-error method" id="method-err" name="methodId">
	                            <option>--</option>
	                            {% for method in methods %}
	                            {% if release.methodId === method.id %}
	                            <option selected value="{{ method.id }}">{{ method.name }}</option>
	                            {% else %}
	                            <option value="{{ method.id }}">{{ method.name }}</option>
	                            {% endif %}
	                            {% endfor %}
	                        </select>
						</div>
                    {% else %}
                        <label class="form-label visually-hidden" for="method">Method</label>
                        <select class="form-control method" id="method" name="methodId">
                            <option>--</option>
                            {% for method in methods %}
                            {% if release.methodId === method.id %}
                            <option selected value="{{ method.id }}">{{ method.name }}</option>
                            {% else %}
                            <option value="{{ method.id }}">{{ method.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        {% endif %}
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="form-group"> <input type="submit" class="button" id="continueBtn" value="Continue"> </div>
        </div>
    </div>
</form>
{% endmacro %}

{% block content %}

<main id="content">
    <label id="page-name" hidden>releases-detail-{{ route.pathParam }}</label>
    {% if route.name === 'RELEASES_TO_LAND' %}
    {{ form('to land', '/releases/land/detail') }}
    {% elif route.name === 'RELEASES_TO_AIR' %}
    {{ form('to air', '/releases/air/detail') }}
    {% elif route.name === 'RELEASES_TO_CONTROLLED_WATERS' %}
    {{ form('to controlled waters', '/releases/water/detail') }}
    {% elif route.name === 'OFFSITE_TRANSFERS_IN_WASTE_WATER' %}
    {{ form('in waste water', '/releases/waste-water/detail') }}
    {% endif %}
</main>

{% endblock %}
